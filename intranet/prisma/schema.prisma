// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

// Modelle für das Intranet

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  role      String   @default("user") // "admin", "student", "staff", "teacher"
  department String? // Für Admins/Staff: z.B. "IT-Support", "Verwaltung"
  measureNumber String? // Format: 123/456/2024 (Nur für Studenten)
  
  // Relation zur Umschulung (nur für Studenten relevant)
  educationTrackId String?
  educationTrack   EducationTrack? @relation(fields: [educationTrackId], references: [id])

  createdAt DateTime @default(now())
  
  // Relationen
  timeEntries   TimeEntry[]
  posts         BulletinPost[]
  inquiries     Inquiry[]
  receivedInquiries Inquiry[] @relation("ReceivedInquiries")
  grades        Grade[]
  teacherSkills TeacherSkill[]
  notifications Notification[]
  invitations   CourseInvitation[]
  
  // Kurse (Studenten und Dozenten)
  coursesAsStudent Course[] @relation("StudentCourses")
  coursesAsTeacher Course[] @relation("TeacherCourses")
}

// Umschulung / Jahrgang (z.B. "Fachinformatiker Winter 2025")
model EducationTrack {
  id        String   @id @default(cuid())
  title     String
  startDate DateTime
  endDate   DateTime
  
  users     User[]   // Schüler in diesem Jahrgang
  courses   Course[] // Kurse, die zu diesem Jahrgang gehören

  createdAt DateTime @default(now())
}

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  
  // Zugehörigkeit zu einer Umschulung
  educationTrackId String?
  educationTrack   EducationTrack? @relation(fields: [educationTrackId], references: [id])

  // Begrenzung
  maxStudents Int @default(25)

  // Relationen
  students    User[]   @relation("StudentCourses")
  teachers    User[]   @relation("TeacherCourses")
  exams       Exam[]
  topics      CourseTopic[] // Themengebiete innerhalb des Kurses
  tags        CourseTag[]
  invitations CourseInvitation[]
  
  createdAt   DateTime @default(now())
}

model CourseInvitation {
  id        String   @id @default(cuid())
  
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  teacherId String
  teacher   User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  status    String   @default("PENDING") // "PENDING", "REJECTED"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([courseId, teacherId])
}

// Themengebiete innerhalb eines Kurses (aus Kursinhalte.md)
model CourseTopic {
  id            String   @id @default(cuid())
  title         String
  durationUnits Int      // Unterrichtseinheiten (UE)
  startDate     DateTime
  endDate       DateTime
  
  courseId      String
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
}

model Room {
  id        String   @id @default(cuid())
  name      String   // z.B. "Raum 101", "Remote"
  capacity  Int      @default(30)
  
  events    CourseEvent[]
  
  createdAt DateTime @default(now())
}

model TimeEntry {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  clockIn   DateTime  @default(now())
  clockOut  DateTime?
  duration  Int?      // Dauer in Minuten (optional für Caching)
  location  String    @default("ON_SITE") // "ON_SITE" (CC/Office) oder "REMOTE" (Telelearning/HomeOffice)
  
  createdAt DateTime @default(now())
}

model Announcement {
  id        String   @id @default(cuid())
  title     String
  content   String
  author    String   // Einfacher String für den MVP
  published Boolean  @default(true)
  createdAt DateTime @default(now())
}

model CourseEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  
  // Raum-Relation statt simplem String
  roomId      String?
  room        Room?    @relation(fields: [roomId], references: [id])
  
  instructor  String?
  
  createdAt   DateTime @default(now())
}

model BulletinPost {
  id          String   @id @default(cuid())
  title       String
  description String
  type        String   // "OFFER" (Biete) oder "SEARCH" (Suche)
  contactInfo String
  
  userId      String?  // Optional für MVP (Gast-Posts möglich machen oder festen User nutzen)
  user        User?    @relation(fields: [userId], references: [id])
  
  expiresAt   DateTime? // Neu: Ablaufdatum für Posts
  
  createdAt   DateTime @default(now())
}

model Exam {
  id          String   @id @default(cuid())
  title       String
  date        DateTime
  content     String   // Was wird abgefragt?
  
  // Location kann hier auch optional ein Room sein, lassen wir erstmal generisch String oder via CourseEvent lösen
  location    String
  
  duration    Int      // Dauer in Minuten
  
  courseId    String?
  course      Course?  @relation(fields: [courseId], references: [id])

  grades      Grade[]  // Noten für diese Klausur
  
  createdAt   DateTime @default(now())
}

model Inquiry {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  recipientId String?
  recipient   User?    @relation("ReceivedInquiries", fields: [recipientId], references: [id])

  subject     String
  message     String
  category    String   // "ADMIN", "TEACHER"
  status      String   @default("OPEN") // "OPEN", "ANSWERED"
  answer      String?  // Antwort vom Personal
  
  createdAt   DateTime @default(now())
  answeredAt  DateTime?
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  message   String
  link      String?  // Optional URL for deep linking
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Tag {
  id      String   @id @default(cuid())
  name    String   @unique
  
  skills  TeacherSkill[]
  courses CourseTag[]
}

model CourseTag {
  id       String @id @default(cuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tagId    String
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([courseId, tagId])
}

// Neu für Profil-Features
model Grade {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  // Verknüpfung zur Prüfung (sauberer als nur String subject)
  examId    String?
  exam      Exam?    @relation(fields: [examId], references: [id])
  
  subject   String   // Fallback oder Fach-Name
  value     Float    // z.B. 2.5
  date      DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeacherSkill {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  
  tagId      String
  tag        Tag      @relation(fields: [tagId], references: [id])
  
  isVerified Boolean  @default(false)
  isActive   Boolean  @default(true)

  @@unique([userId, tagId])
}
